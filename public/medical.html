<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ë£Œë¹„ ì§€ì› ì‹ ì²­ - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .medical-row { background: #fffcfc; border: 1px solid #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 15px; position: relative; }
        .section-title { border-left: 5px solid #dc3545; padding-left: 15px; margin-bottom: 25px; font-weight: bold; }
    </style>
</head>
<body>

<div class="form-card">
    <h3 class="text-center fw-bold text-danger mb-4">
        {% if edit_mode %} <i class="bi bi-pencil-square"></i> ì˜ë£Œë¹„ ì‹ ì²­ ìˆ˜ì • {% else %} ğŸ¥ ì˜ë£Œë¹„ ì§€ì› ì‹ ì²­ì„œ {% endif %}
    </h3>

    <form id="welfareForm">
        <input type="hidden" name="edit_idx" value="{{ edit_idx if edit_mode else '' }}">
        <input type="hidden" name="type" value="ì˜ë£Œë¹„ì§€ì›">
        
        <div class="section-title">1. ì‹ ì²­ì¸ ì •ë³´</div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="fw-bold">ë¶€ì„œ</label>
                <input type="text" name="department" class="form-control" value="{{ data.ë¶€ì„œ if edit_mode else '' }}" required>
            </div>
            <div class="col-md-4">
                <label class="fw-bold">ì§ê¸‰</label>
                <input type="text" name="position" class="form-control" value="{{ data.ì§ê¸‰ if edit_mode else '' }}" required>
            </div>
            <div class="col-md-4">
                <label class="fw-bold">ì„±ëª…</label>
                <input type="text" class="form-control bg-light" value="{{ user_name }}" readonly>
            </div>
            <div class="col-md-6">
                <label class="fw-bold">ì…ì‚¬ì¼</label>
                <input type="date" name="joinDate" class="form-control" value="{{ data.ì…ì‚¬ì¼ if edit_mode else '' }}" required>
            </div>
            <div class="col-md-6">
                <label class="fw-bold">ì „í™”ë²ˆí˜¸</label>
                <input type="text" name="phone" class="form-control" value="{{ data.ì „í™”ë²ˆí˜¸ if edit_mode else '' }}" placeholder="010-0000-0000" required>
            </div>
        </div>

        <div class="section-title d-flex justify-content-between align-items-center">
            2. ì§„ë£Œ ìƒì„¸ë‚´ì—­
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="addRow()">+ ë‚´ì—­ ì¶”ê°€</button>
        </div>
        
        <div id="rowContainer">
            </div>

        <div class="my-4 p-3 bg-light rounded d-flex justify-content-between align-items-center border">
            <h5 class="m-0 fw-bold">ì´ ì‹ ì²­ ê¸ˆì•¡ í•©ê³„</h5>
            <div class="input-group w-50">
                <input type="number" name="amount" id="totalAmt" class="form-control fw-bold text-end" value="{{ data.ì‹ ì²­ê¸ˆì•¡ if edit_mode else 0 }}" readonly>
                <span class="input-group-text">ì›</span>
            </div>
        </div>

        <div class="mb-4">
            <label class="fw-bold mb-1">ê³„ì¢Œë²ˆí˜¸ (ì€í–‰/ë²ˆí˜¸/ì˜ˆê¸ˆì£¼)</label>
            <input type="text" name="account" class="form-control" value="{{ data.ê³„ì¢Œë²ˆí˜¸ if edit_mode else '' }}" required>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-danger btn-lg shadow fw-bold">
                {% if edit_mode %} âœ… ìˆ˜ì • ì™„ë£Œ ë° ì¬ì œì¶œ {% else %} ğŸ¥ ì‹ ì²­ì„œ ì œì¶œí•˜ê¸° {% endif %}
            </button>
            <a href="/my_status" class="btn btn-outline-secondary">ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°</a>
        </div>
    </form>
</div>

<script>
    // ëª©ë¡ ì¤„ ì¶”ê°€ í•¨ìˆ˜ (ê¸°ë³¸ê°’ ì§€ì›)
    function addRow(hospital = '', date = '', price = '') {
        const container = document.getElementById('rowContainer');
        const div = document.createElement('div');
        div.className = 'medical-row shadow-sm';
        div.innerHTML = `
            <button type="button" class="btn-close position-absolute" style="top:10px;right:10px;" onclick="this.parentElement.remove(); calcTotal();"></button>
            <div class="row g-2">
                <div class="col-md-4"><label class="small text-muted">ì§„ë£Œê¸°ê´€</label><input type="text" class="form-control med_org" value="${hospital}" required></div>
                <div class="col-md-4"><label class="small text-muted">ì§„ë£Œì¼ì</label><input type="date" class="form-control med_date" value="${date}" required></div>
                <div class="col-md-4"><label class="small text-muted">ê¸ˆì•¡</label><input type="number" class="form-control med_amount" oninput="calcTotal()" value="${price}" required></div>
            </div>`;
        container.appendChild(div);
    }

    // í•©ê³„ ê³„ì‚°
    function calcTotal() {
        let sum = 0;
        document.querySelectorAll('.med_amount').forEach(i => sum += (parseInt(i.value) || 0));
        document.getElementById('totalAmt').value = sum;
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰
    window.onload = function() {
        // [ìˆ˜ì • ëª¨ë“œ ë°ì´í„° ë³µêµ¬ ë¡œì§]
        const rawDetail = `{{ data.ì„¸ë¶€ë‚´ìš© if edit_mode else '' }}`;
        
        if (rawDetail) {
            // "ë³‘ì›|ë‚ ì§œ|ê¸ˆì•¡||ë³‘ì›2|ë‚ ì§œ2|ê¸ˆì•¡2" í˜•íƒœë¥¼ ë¶„í•´
            const records = rawDetail.split('||');
            records.forEach(record => {
                const parts = record.split('|');
                if (parts.length === 3) {
                    addRow(parts[0], parts[1], parts[2]);
                }
            });
        } else {
            addRow(); // ì‹ ê·œ ì‹ ì²­ ì‹œ ë¹ˆ ì¤„ 1ê°œ ì¶”ê°€
        }
        calcTotal();
    };

    // ì œì¶œ ì²˜ë¦¬
    document.getElementById('welfareForm').onsubmit = async (e) => {
        e.preventDefault();
        
        // ìˆ˜ì • ëª¨ë“œ ì—¬ë¶€ì— ë”°ë¼ ì„œë²„ ì£¼ì†Œ ê²°ì •
        const url = "{{ '/edit_submit' if edit_mode else '/submit' }}";
        const formData = new FormData(e.target);
        
        // ëª©ë¡ ë°ì´í„°ë¥¼ detail_textë¡œ í¬ì¥
        let details = [];
        document.querySelectorAll('.medical-row').forEach(row => {
            const org = row.querySelector('.med_org').value;
            const date = row.querySelector('.med_date').value;
            const amt = row.querySelector('.med_amount').value;
            if(org) details.push(`${org}|${date}|${amt}`);
        });
        formData.append('detail_text', details.join('||'));

        try {
            const res = await fetch(url, { method: 'POST', body: formData });
            const result = await res.json();
            if(result.status === 'success') {
                alert(url.includes('edit') ? 'ì‹ ì²­ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = '/my_status';
            } else {
                alert('ì˜¤ë¥˜: ' + result.message);
            }
        } catch (err) {
            alert('ì„œë²„ì™€ í†µì‹ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };
</script>
</body>
</html>