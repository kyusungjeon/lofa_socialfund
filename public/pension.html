<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë³µì§€ì—°ê¸ˆ ì§€ì› ì‹ ì²­ - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f9; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 900px; margin: auto; }
        .section-title { border-left: 5px solid #0d6efd; padding-left: 10px; margin-bottom: 20px; font-weight: bold; }
        /* íŒì—…(iframe) ì‹œ í•˜ë‹¨ ë²„íŠ¼ ìˆ¨ê¹€ */
        body.is-popup .original-buttons { display: none !important; }
        body.is-popup { background: white; padding: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div class="form-card">
        <h3 class="text-center fw-bold text-primary mb-5">ì§ì› ë³µì§€ì—°ê¸ˆ ì§€ì› ì‹ ì²­ì„œ</h3>
        <form id="pensionForm">
            <input type="hidden" name="index" value="{{ edit_idx if edit_mode else '' }}">
            <input type="hidden" name="type" value="ë³µì§€ì—°ê¸ˆì§€ì›">

            <div class="section-title">1. ì‹ ì²­ì¸ ì •ë³´</div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">ì†Œì†ë¶€ì„œ</label>
                    <input type="text" name="department" class="form-control" value="{{ data.ë¶€ì„œ if edit_mode else '' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì§ê¸‰</label>
                    <input type="text" name="position" class="form-control" value="{{ data.ì§ê¸‰ if edit_mode else '' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì‚¬ë²ˆ</label>
                    <input type="text" name="employeeId" class="form-control bg-light" value="{{ session['user_id'] }}" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì„±ëª…</label>
                    <input type="text" class="form-control bg-light" value="{{ user_name }}" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì…ì‚¬ì¼</label>
                    <input type="date" name="joinDate" class="form-control" value="{{ data.ì…ì‚¬ì¼ if edit_mode else '' }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" name="phone" class="form-control" value="{{ data.ì „í™”ë²ˆí˜¸ if edit_mode else '' }}">
                </div>
            </div>

            <div class="section-title">2. ì§€ì› ë‚´ìš©</div>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label">ì§€ì›í•­ëª©</label>
                    <input type="text" name="disease_name" class="form-control" value="{{ data['ì§ˆë³‘/í•­ëª©ëª…'] if edit_mode else '' }}" placeholder="ì˜ˆ: ê°œì¸ì—°ê¸ˆ ì§€ì›" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">ê¸ˆìœµê¸°ê´€</label>
                    <input type="text" name="target_name" class="form-control" value="{{ data.ëŒ€ìƒìì„±ëª… if edit_mode else '' }}" placeholder="ì˜ˆ: OOì€í–‰" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ë³¸ì¸ë¶€ë‹´ê¸ˆì•¡</label>
                    <input type="number" name="self_pay" class="form-control" value="{{ data.ë³¸ì¸ë¶€ë‹´ê¸ˆ if edit_mode else '' }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì‹ ì²­ê¸ˆì•¡</label>
                    <input type="number" name="amount" class="form-control" value="{{ data.ê¸ˆì•¡ if edit_mode else '' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
                    <input type="text" name="account" class="form-control" value="{{ data.ê³„ì¢Œë²ˆí˜¸ if edit_mode else '' }}" required>
                </div>
            </div>

            <div class="section-title">3. ì²¨ë¶€ì„œë¥˜</div>
            <div class="mb-4">
                <label class="form-label small text-muted">ë³µì§€ì—°ê¸ˆ ê°€ì…ì‚¬ì‹¤ ë° ë³¸ì¸ë¶€ë‹´ë¶„ ë‚©ì… ì•½ì • ì¦ëª… ìë£Œ</label>
                <input type="file" name="attachment" class="form-control">
            </div>

            <div class="original-buttons mt-5 border-top pt-4">
                <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">ì§€ì› ì‹ ì²­í•˜ê¸°</button>
                <a href="/" class="btn btn-outline-secondary w-100 mt-2">ë©”ì¸ìœ¼ë¡œ</a>
            </div>
        </form>
    </div>
</div>

<script>
    // íŒì—… ê°ì§€ ë¡œì§
    if (window.self !== window.top) document.body.classList.add('is-popup');

    document.getElementById('pensionForm').onsubmit = async (e) => {
        e.preventDefault();
        const url = "{{ '/edit_submit' if edit_mode else '/submit' }}";
        
        try {
            const res = await fetch(url, { method: 'POST', body: new FormData(e.target) });
            const result = await res.json();
            
            if (result.status === 'success') {
                if (window.self !== window.top) {
                    // ë¶€ëª¨ ì°½(my_status)ì— ì„±ê³µ ì‹ í˜¸ ì „ì†¡
                    window.parent.postMessage('success', '*');
                } else {
                    alert('ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.href = '/my_status';
                }
            } else {
                alert('ì˜¤ë¥˜: ' + result.message);
            }
        } catch (err) {
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };
</script>
<div class="form-card shadow p-4 bg-white rounded">
    <h3 class="fw-bold text-warning mb-4 text-center text-dark">ğŸ’° ì§ì› ë³µì§€ì—°ê¸ˆ ì§€ì› ì‹ ì²­ì„œ</h3>
    <form id="welfareForm">
        <input type="hidden" name="type" value="ë³µì§€ì—°ê¸ˆ">
        <div class="row g-3 mb-4">
            <div class="col-md-6"><label>ì§€ì›í•­ëª©</label><input type="text" name="pension_item" class="form-control" value="{{ data.ì„¸ë¶€ë‚´ìš©.split('|')[0] if data.ì„¸ë¶€ë‚´ìš© else '' }}" placeholder="ì˜ˆ: ê°œì¸ì—°ê¸ˆ"></div>
            <div class="col-md-6"><label>ê¸ˆìœµê¸°ê´€</label><input type="text" name="bank_name" class="form-control" value="{{ data.ì„¸ë¶€ë‚´ìš©.split('|')[1] if data.ì„¸ë¶€ë‚´ìš© and '|' in data.ì„¸ë¶€ë‚´ìš© else '' }}"></div>
            <div class="col-12"><label>ë³¸ì¸ë¶€ë‹´ê¸ˆì•¡</label><input type="number" name="my_pay" class="form-control" value="{{ data.ë³¸ì¸ë¶€ë‹´ê¸ˆì•¡ if data else 0 }}"></div>
        </div>
        <div class="mb-3"><label>ì‹ ì²­ ê¸ˆì•¡</label><input type="number" name="amount" class="form-control fw-bold" value="{{ data.ì‹ ì²­ê¸ˆì•¡ if data else 0 }}"></div>
        <div class="mb-4"><label>ê³„ì¢Œë²ˆí˜¸</label><input type="text" name="account" class="form-control" value="{{ data.ê³„ì¢Œë²ˆí˜¸ if data else '' }}" required></div>
        <div class="alert alert-warning text-dark small"><b>ì²¨ë¶€ì„œë¥˜:</b> ë³µì§€ì—°ê¸ˆ ê°€ì…ì‚¬ì‹¤ ë° ë³¸ì¸ë¶€ë‹´ë¶„ ë‚©ì… ì•½ì • ì¦ë¹™ ìë£Œ</div>
        <button type="submit" class="btn btn-warning w-100 btn-lg shadow">ì œì¶œí•˜ê¸°</button>
    </form>
</div>
</body>
</html>