<div class="form-card shadow">
    <h3 class="text-center fw-bold text-primary mb-4">{% if edit_mode %}ğŸ”„ ì¥í•™ê¸ˆ ì§€ì› ìˆ˜ì •{% else %}ğŸ“ ì¥í•™ê¸ˆ ì§€ì› ì‹ ì²­ì„œ{% endif %}</h3>
    <div id="hiddenStore" data-detail="{{ data.ì„¸ë¶€ë‚´ìš© if data.ì„¸ë¶€ë‚´ìš© else '' }}" style="display:none;"></div>
    <form id="welfareForm">
        <input type="hidden" name="index" value="{{ edit_idx if edit_mode else '' }}">
        <input type="hidden" name="type" value="ì¥í•™ê¸ˆì§€ì›">
        <div class="row g-3 mb-4">
            <div class="col-md-4"><label class="fw-bold">ë¶€ì„œ</label><input type="text" name="department" class="form-control" value="{{ data.ë¶€ì„œ if data else '' }}" required></div>
            <div class="col-md-4"><label class="fw-bold">ì§ê¸‰</label><input type="text" name="position" class="form-control" value="{{ data.ì§ê¸‰ if data else '' }}" required></div>
            <div class="col-md-4"><label class="fw-bold">ì„±ëª…</label><input type="text" class="form-control bg-light" value="{{ user_name }}" readonly></div>
        </div>
        <div class="d-flex justify-content-between mb-2"><strong>ìë…€ ì •ë³´ (ëª©ë¡)</strong><button type="button" class="btn btn-sm btn-primary" onclick="addRow()">+ ìë…€ ì¶”ê°€</button></div>
        <div id="rowContainer"></div>
        <div class="my-4 p-3 bg-light border rounded">
            <label class="fw-bold">ì´ ì‹ ì²­ ê¸ˆì•¡</label>
            <input type="number" name="amount" id="totalAmt" class="form-control fw-bold text-end" value="{{ data.ì‹ ì²­ê¸ˆì•¡ if data else 0 }}" readonly>
        </div>
        <div class="mb-4"><label class="fw-bold text-primary">ê³„ì¢Œë²ˆí˜¸ (ì€í–‰/ë²ˆí˜¸/ì˜ˆê¸ˆì£¼)</label><input type="text" name="account" class="form-control" value="{{ data.ê³„ì¢Œë²ˆí˜¸ if data else '' }}" required></div>
        <div class="alert alert-info small"><b>ì²¨ë¶€ì„œë¥˜:</b> ì¬í•™ì¦ëª…ì„œ, ì„±ì ì¦ëª…ì„œ, ì£¼ë¯¼ë“±ë¡ë“±ë³¸, ë“±ë¡ê¸ˆì²­êµ¬ì„œ/ì˜ìˆ˜ì¦ ë“±</div>
        <button type="submit" class="btn btn-primary btn-lg w-100 shadow">{{ 'ìˆ˜ì • ì™„ë£Œ ë° ì¬ì œì¶œ' if edit_mode else 'ì‹ ì²­ì„œ ì œì¶œí•˜ê¸°' }}</button>
    </form>
</div>
<script>
    function addRow(n='', g='', a='') {
        const div = document.createElement('div'); div.className = 'p-3 border rounded mb-2 position-relative bg-white';
        div.innerHTML = `<button type="button" class="btn-close position-absolute" style="top:5px;right:5px;" onclick="this.parentElement.remove(); calc();"></button>
            <div class="row g-2">
                <div class="col-md-4"><input type="text" name="child_name[]" class="form-control form-control-sm" placeholder="ìë…€ì„±ëª…" value="${n}" required></div>
                <div class="col-md-4"><input type="text" name="child_grade[]" class="form-control form-control-sm" placeholder="í•™ë…„" value="${g}" required></div>
                <div class="col-md-4"><input type="number" name="child_amount[]" class="form-control form-control-sm amt-in" oninput="calc()" placeholder="ì‹ ì²­ê¸ˆì•¡" value="${a}" required></div>
            </div>`;
        document.getElementById('rowContainer').appendChild(div);
    }
    function calc() {
        let s = 0; document.querySelectorAll('.amt-in').forEach(i => s += (parseInt(i.value) || 0));
        document.getElementById('totalAmt').value = s;
    }
    window.onload = function() {
        const raw = document.getElementById('hiddenStore').getAttribute('data-detail');
        if(raw) raw.split('||').forEach(r => { const p = r.split('|'); if(p.length==3) addRow(p[0],p[1],p[2]); });
        else addRow(); calc();
    };
    document.getElementById('welfareForm').onsubmit = async (e) => {
        e.preventDefault();
        const url = "{{ '/edit_submit' if edit_mode else '/submit' }}";
        const res = await fetch(url, { method: 'POST', body: new FormData(e.target) });
        if((await res.json()).status==='success') { alert('ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); location.href='/my_status'; }
    };
</script>